<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dragon Hub IA — Assistente de Programação Lua</title>
  <meta name="description" content="Dragon Hub IA — Chat especializado em programação Lua e scripts." />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <!-- Highlight.js (code highlight) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Marked (markdown) & DOMPurify (sanitize) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/lua.min.js"></script>

  <style>
    :root{
      --bg:#0a0b10;
      --panel:#12131a;
      --soft:#1a1c26;
      --text:#e6e7ee;
      --muted:#9aa0b4;
      --accent:#8b5cf6;     /* roxo */
      --accent-2:#06d6a0;   /* verde */
      --danger:#ef4444;
      --border:#242634;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 800px at 110% -10%, rgba(6,214,160,0.08), transparent 40%),
                 radial-gradient(1000px 700px at -10% 0%, rgba(139,92,246,0.10), transparent 40%),
                 var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(140%) blur(8px);
      background:linear-gradient(180deg, rgba(18,19,26,0.9), rgba(18,19,26,0.6));
      border-bottom:1px solid var(--border);
    }
    .bar{
      max-width:1080px; margin:0 auto; padding:14px 18px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px;
    }
    .brand .logo{
      width:36px; height:36px; border-radius:10px;
      background: conic-gradient(from 210deg, var(--accent), var(--accent-2));
      box-shadow: 0 0 18px rgba(139,92,246,.45), inset 0 0 12px rgba(6,214,160,.25);
      display:grid; place-items:center; color:#0b0c12;
    }
    .brand .name{font-size:1.02rem}
    .brand .tag{color:var(--muted); font-weight:600; font-size:.88rem}
    .actions{display:flex; align-items:center; gap:8px}
    .icon-btn{
      border:1px solid var(--border);
      background:linear-gradient(180deg,#171923,#12131a);
      color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer;
    }
    .icon-btn:hover{border-color:#2d3144}
    main{
      max-width:1080px; width:100%; margin:0 auto; padding:18px; flex:1; display:flex; flex-direction:column; gap:12px;
    }
    .chat{
      background:linear-gradient(180deg,#10121a,#0e1017);
      border:1px solid var(--border); border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:10px; min-height:60vh;
    }
    .messages{flex:1; overflow:auto; display:flex; flex-direction:column; gap:14px; padding:6px 6px 2px}
    .msg{
      display:flex; gap:12px; align-items:flex-start
    }
    .avatar{
      width:34px; height:34px; border-radius:8px; flex:0 0 auto; display:grid; place-items:center;
      border:1px solid var(--border);
    }
    .avatar.user{background:#18202a; color:#9dd2ff}
    .avatar.ai{background:#1a1426; color:#c9b5ff}
    .bubble{
      background:var(--soft); border:1px solid var(--border);
      padding:12px 14px; border-radius:12px; max-width:100%;
      box-shadow:0 1px 0 rgba(255,255,255,0.03) inset;
      overflow:auto;
    }
    .bubble pre{background:#0f1118; border:1px solid #222536; border-radius:10px; padding:12px; overflow:auto}
    .bubble code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.95em}
    .bubble h1,.bubble h2,.bubble h3{margin:.4em 0}
    .bubble p{line-height:1.6}
    .bubble ul{margin:.2em 0 .6em 1.1em}
    .hint{color:var(--muted); font-size:.92rem}
    .composer{
      display:flex; gap:10px; align-items:flex-end; margin-top:6px;
      background:linear-gradient(180deg,#12141d,#10121a); border:1px solid var(--border); border-radius:14px; padding:8px;
    }
    textarea{
      flex:1; min-height:50px; max-height:200px; resize:vertical;
      border:none; outline:none; background:transparent; color:var(--text); font-size:1rem; padding:8px 10px;
    }
    .send{
      background:linear-gradient(180deg, var(--accent), #6d46f3);
      color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer;
      box-shadow:0 4px 18px rgba(139,92,246,.35);
    }
    .send:disabled{opacity:.6; cursor:not-allowed}
    .helper{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:.9rem; margin:2px 6px 0}

    /* Settings modal */
    .modal{
      position:fixed; inset:0; display:none; place-items:center; backdrop-filter:blur(6px);
      background:rgba(10,11,16,0.55); z-index:50;
    }
    .modal.open{display:grid}
    .card{
      width:min(720px, 92vw); background:#0f1118; border:1px solid var(--border); border-radius:16px; padding:16px 16px 12px;
      box-shadow:0 10px 40px rgba(0,0,0,.45);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .field{flex:1; min-width:220px; display:flex; flex-direction:column; gap:6px}
    .label{font-weight:700; font-size:.92rem}
    .input, .select, .textarea{
      background:#12131a; border:1px solid var(--border); color:var(--text); border-radius:10px; padding:10px 12px;
      outline:none;
    }
    .textarea{min-height:110px; font-family:Inter, sans-serif}
    .savebar{display:flex; justify-content:space-between; align-items:center; margin-top:10px}
    .btn{
      background:linear-gradient(180deg, var(--accent-2), #08b788);
      color:#0b0c12; border:none; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer;
    }
    .ghost{background:#181b27; color:var(--text); border:1px solid var(--border)}
    .small{font-size:.88rem; color:var(--muted)}
    .copy-btn{
      position:absolute; top:8px; right:8px; border:1px solid #2a2e44; background:#111423; color:#d8def1;
      padding:4px 8px; border-radius:8px; font-size:.8rem; cursor:pointer;
    }
    .codewrap{position:relative}
    .badge{
      font-size:.75rem; color:#cbd5ff; background:#1a1c2a; border:1px solid #2b3050; border-radius:999px; padding:4px 10px; font-weight:700
    }
    .warning{color:#ffb4b4}
    footer{
      max-width:1080px; margin:10px auto 26px; padding:0 18px; color:var(--muted); font-size:.9rem;
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
    }
    a{color:#b7c7ff}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-dragon"></i></div>
        <div>
          <div class="name">Dragon Hub IA</div>
          <div class="tag">Assistente de programação • Lua e scripts</div>
        </div>
      </div>
      <div class="actions">
        <button id="openSettings" class="icon-btn"><i class="fa-solid fa-gear"></i> Configurações</button>
      </div>
    </div>
  </header>

  <main>
    <div class="chat">
      <div id="messages" class="messages"></div>

      <div class="composer">
        <textarea id="userInput" rows="1" placeholder="Escreva sua pergunta em português. Dica: descreva o contexto, mostre o erro e o que você já tentou. Shift+Enter = nova linha"></textarea>
        <button id="sendBtn" class="send"><i class="fa-solid fa-paper-plane"></i></button>
      </div>
      <div class="helper">
        <span class="hint">
          Dica: para usar com modelo real, abra Configurações e cole sua chave de API (OpenRouter ou OpenAI). Respostas são focadas em Lua.
        </span>
      </div>
    </div>

    <footer>
      <div>
        <span class="badge">Dragon Hub IA</span>
        &nbsp;•&nbsp; Especialista em Lua (Roblox, Neovim, OpenResty, scripts CLI).
      </div>
      <div class="small">
        Este projeto segue diretrizes de uso responsável. Não gera conteúdo nocivo ou ilegal.
      </div>
    </footer>
  </main>

  <!-- Settings Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="card">
      <h3 style="margin:4px 0 12px 2px">Configurações</h3>
      <div class="row">
        <div class="field" style="min-width:150px;flex:.6">
          <label class="label">Provedor</label>
          <select id="provider" class="select">
            <option value="openrouter">OpenRouter (recomendado)</option>
            <option value="openai">OpenAI</option>
          </select>
          <div class="small">OpenRouter permite vários modelos e costuma ter custo menor. É compatível com a API da OpenAI.</div>
        </div>
        <div class="field">
          <label class="label">Modelo</label>
          <input id="model" class="input" placeholder="Ex: openai/gpt-4o-mini (OpenRouter) ou gpt-4o-mini (OpenAI)">
          <div class="small">Sugestões OpenRouter: openai/gpt-4o-mini, qwen/qwen-2.5-coder, mistralai/mistral-nemo. Em OpenAI: gpt-4o-mini.</div>
        </div>
      </div>

      <div class="row">
        <div class="field" style="flex:1">
          <label class="label">API Key</label>
          <input id="apiKey" class="input" type="password" placeholder="Cole sua chave aqui">
          <div class="small">Sua chave fica salva apenas no seu navegador (localStorage).</div>
        </div>
      </div>

      <div class="row">
        <div class="field" style="flex:1">
          <label class="label">Prompt do sistema (opcional)</label>
          <textarea id="systemPrompt" class="textarea" spellcheck="false"></textarea>
          <div class="small">Ajuste o tom e as instruções do assistente. Mantemos foco em Lua e boas práticas.</div>
        </div>
      </div>

      <div class="savebar">
        <button id="resetBtn" class="btn ghost"><i class="fa-solid fa-rotate"></i> Restaurar padrão</button>
        <div style="display:flex; gap:8px; align-items:center">
          <span class="small">As alterações salvam automaticamente.</span>
          <button id="closeSettings" class="btn"><i class="fa-solid fa-check"></i> Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========== Utils ==========
    function $(sel, root=document){ return root.querySelector(sel) }
    function el(tag, cls){ const e=document.createElement(tag); if(cls) e.className=cls; return e }
    function sanitize(html){ return DOMPurify.sanitize(html) }

    // Markdown config
    marked.setOptions({
      gfm: true,
      breaks: true
    });

    // ========== State & Config ==========
    const storeKey = "dragonhubia:cfg";
    const defaultSystemPrompt = `
Você é Dragon Hub IA, um assistente especializado em programação Lua e scripts. Regras:
- Responda em português do Brasil, de forma clara e objetiva.
- Entenda rapidamente o contexto do usuário (ambiente: Roblox, Neovim, OpenResty/Nginx, ferramentas de automação, etc).
- Quando gerar código, formate em Markdown com blocos \`\`\`lua ou linguagem apropriada.
- Inclua comentários úteis diretamente no código quando fizer sentido.
- Sugira boas práticas (legibilidade, modularização, segurança).
- Se a solicitação envolver algo perigoso, ilegal, exploração ou malicioso, recuse educadamente e ofereça alternativas seguras.
- Se o problema não for Lua, ainda ajude com serenidade (ex: shell, JSON, Docker), mas priorize Lua.
- Quando houver erro, tente explicar a causa, sugerir correções, e oferecer um exemplo mínimo reproduzível (MR).
`.trim();

    const defaultCfg = {
      provider: "openrouter",
      model: "openai/gpt-4o-mini", // bom padrão geral; troque por um coder no OpenRouter se preferir
      apiKey: "",
      systemPrompt: defaultSystemPrompt
    };

    let cfg = loadCfg();
    function loadCfg(){
      try {
        const saved = JSON.parse(localStorage.getItem(storeKey) || "{}");
        return { ...defaultCfg, ...saved };
      } catch(e) {
        return { ...defaultCfg };
      }
    }
    function saveCfg(partial){
      cfg = { ...cfg, ...partial };
      localStorage.setItem(storeKey, JSON.stringify(cfg));
      reflectCfg();
    }

    // ========== UI: Settings Modal ==========
    const modal = $("#modal");
    $("#openSettings").addEventListener("click", () => { modal.classList.add("open"); modal.setAttribute("aria-hidden","false"); });
    $("#closeSettings").addEventListener("click", () => { modal.classList.remove("open"); modal.setAttribute("aria-hidden","true"); });
    modal.addEventListener("click", (e)=>{ if(e.target === modal) $("#closeSettings").click() });

    function reflectCfg(){
      $("#provider").value = cfg.provider;
      $("#model").value = cfg.model;
      $("#apiKey").value = cfg.apiKey;
      $("#systemPrompt").value = cfg.systemPrompt;
    }
    reflectCfg();

    $("#provider").addEventListener("change", e => {
      const provider = e.target.value;
      let model = cfg.model;
      if(provider === "openai" && (model.includes("/") || model === defaultCfg.model)) {
        model = "gpt-4o-mini";
      }
      if(provider === "openrouter" && !model.includes("/")) {
        model = "openai/gpt-4o-mini";
      }
      saveCfg({ provider, model });
    });
    $("#model").addEventListener("input", e => saveCfg({ model: e.target.value.trim() }));
    $("#apiKey").addEventListener("input", e => saveCfg({ apiKey: e.target.value.trim() }));
    $("#systemPrompt").addEventListener("input", e => saveCfg({ systemPrompt: e.target.value }));
    $("#resetBtn").addEventListener("click", ()=>{
      localStorage.removeItem(storeKey);
      cfg = loadCfg();
      reflectCfg();
    });

    // ========== Chat Rendering ==========
    const messagesEl = $("#messages");
    const sendBtn = $("#sendBtn");
    const input = $("#userInput");

    const chatHistory = [];
    function pushMessage(role, content){
      chatHistory.push({ role, content });
      renderMessage(role, content);
    }

    function renderMessage(role, content){
      const row = el("div", "msg");
      const avatar = el("div", "avatar " + (role === "user" ? "user" : "ai"));
      avatar.innerHTML = role === "user" ? '<i class="fa-solid fa-user"></i>' : '<i class="fa-solid fa-dragon"></i>';
      const bubble = el("div", "bubble");

      if(role === "assistant"){
        const html = sanitize(marked.parse(content));
        bubble.innerHTML = html;
        // Enhance code blocks
        enhanceCodeBlocks(bubble);
      } else {
        // User content as plain text
        bubble.textContent = content;
      }

      row.appendChild(avatar);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      // Highlight code (assistant)
      if(role === "assistant"){ try { hljs.highlightAll(); } catch(_){} }
    }

    function enhanceCodeBlocks(scope){
      scope.querySelectorAll('pre code').forEach((codeEl)=>{
        const pre = codeEl.parentElement;
        if(pre && !pre.classList.contains("codewrap")){
          pre.classList.add("codewrap");
          const btn = el("button","copy-btn");
          btn.textContent = "Copiar";
          btn.addEventListener("click", async ()=>{
            try{
              await navigator.clipboard.writeText(codeEl.innerText);
              btn.textContent = "Copiado!";
              setTimeout(()=> btn.textContent="Copiar", 1400);
            }catch(e){
              btn.textContent = "Erro";
              setTimeout(()=> btn.textContent="Copiar", 1400);
            }
          });
          pre.appendChild(btn);
        }
      });
    }

    // Welcome and instructions
    pushMessage("assistant",
`Olá! Eu sou a Dragon Hub IA, seu assistente de programação focado em Lua.  
Para começar:
- Abra “Configurações” e cole sua API key do OpenRouter ou OpenAI.
- Escreva sua dúvida: descreva contexto (ex.: Roblox/Neovim/OpenResty), mostre trechos de código e o erro.
- Eu responderei com exemplos em Lua e boas práticas.

Exemplo:
\`\`\`lua
-- Função utilitária: divide string por separador
local function split(s, sep)
  local t = {}
  for part in string.gmatch(s, "([^"..sep.."]+)") do
    table.insert(t, part)
  end
  return t
end

print(table.concat(split("a,b,c", ","), " | "))
\`\`\`
`);

    // ========== Send flow ==========
    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        send();
      }
    });
    sendBtn.addEventListener("click", send);

    let isBusy = false;

    async function send(){
      const text = input.value.trim();
      if(!text || isBusy) return;
      if(!cfg.apiKey){
        pushMessage("assistant", "Para usar modelos reais, abra “Configurações” e informe sua API key. Enquanto isso, posso dar dicas básicas de Lua. O que você quer criar?");
        return;
      }
      pushMessage("user", text);
      input.value = "";
      isBusy = true; sendBtn.disabled = true;

      // Compose messages for API
      const apiMessages = [
        { role:"system", content: cfg.systemPrompt },
        ...chatHistory // includes all previous user/assistant turns
      ];

      // Show typing placeholder
      const placeholderId = "ph-"+Date.now();
      pushMessage("assistant", "Pensando...");
      const phIndex = chatHistory.length-1;

      try {
        const reply = await callLLM(apiMessages);
        // Replace placeholder content
        chatHistory[phIndex] = { role: "assistant", content: reply };
        // Rerender last bubble nicely:
        messagesEl.lastElementChild.querySelector(".bubble").innerHTML = sanitize(marked.parse(reply));
        enhanceCodeBlocks(messagesEl.lastElementChild.querySelector(".bubble"));
        hljs.highlightAll();
      } catch(err){
        const msg = err?.message || String(err);
        chatHistory[phIndex] = { role:"assistant", content: "Ocorreu um erro ao chamar o modelo.\n\nDetalhes: " + msg };
        messagesEl.lastElementChild.querySelector(".bubble").textContent = "Ocorreu um erro ao chamar o modelo.\n\nDetalhes: " + msg;
      } finally {
        isBusy = false; sendBtn.disabled = false;
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }
    }

    async function callLLM(messages){
      const provider = cfg.provider;
      const apiKey = cfg.apiKey;
      const model = cfg.model || (provider === "openai" ? "gpt-4o-mini" : "openai/gpt-4o-mini");

      let url = "";
      let headers = {};
      let body = {};

      if(provider === "openrouter"){
        url = "https://openrouter.ai/api/v1/chat/completions";
        headers = {
          "Authorization": "Bearer " + apiKey,
          "Content-Type": "application/json",
          // Dica: opcional informar referer e título da app
          "HTTP-Referer": location.origin,
          "X-Title": "Dragon Hub IA"
        };
        body = {
          model,
          messages,
          temperature: 0.2
        };
      } else if(provider === "openai"){
        url = "https://api.openai.com/v1/chat/completions";
        headers = {
          "Authorization": "Bearer " + apiKey,
          "Content-Type": "application/json"
        };
        body = {
          model,
          messages,
          temperature: 0.2
        };
      } else {
        throw new Error("Provedor desconhecido");
      }

      const res = await fetch(url, { method:"POST", headers, body: JSON.stringify(body) });
      if(!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error("HTTP "+res.status+" — "+t);
      }
      const json = await res.json();
      const text = json?.choices?.[0]?.message?.content || "";
      if(!text) throw new Error("Resposta vazia do modelo.");
      return text;
    }
  </script>
</body>
</html>
